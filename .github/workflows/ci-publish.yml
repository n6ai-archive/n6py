name: CI Publish

# Manual dispatch only,
# that way we can control when and where to release a new version of a specific package.
on:
  workflow_dispatch:
    inputs:
      repository:
        type: choice
        description: 'Repository to release the package to'
        required: true
        options:
          - test.pypi
          - pypi

env:
  PYPI_TOKEN: ${{ (
    contains(github.event.inputs.repository, 'test.pypi') && secrets.TEST_PYPI_API_TOKEN || secrets.PYPI_API_TOKEN
    ) }}
  REPOSITORY_NAME: ${{ (
    contains(github.event.inputs.repository, 'test.pypi') && 'testpypi' || 'pypi'
    ) }}
  REPOSITORY_URL: ${{ (
    contains(github.event.inputs.repository, 'test.pypi') && 'https://test.pypi.org/legacy/' || null
    ) }}

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build and publish to test.pypi
        uses: JRubics/poetry-publish@v1.15
        with:
          pypi_token: ${{ env.PYPI_TOKEN }}
          repository_name: ${{ env.REPOSITORY_NAME }}
          repository_url: ${{ env.REPOSITORY_URL }}